name: Miqa - PR comment

on:
  workflow_call:
    inputs:
      miqa_endpoint:
        type: string
        required: true
      installation_id:
        type: string
        required: false
        default: ""
      trigger_map:
        type: string
        required: true
        description: JSON mapping test name -> trigger id
      default_test:
        type: string
        required: false
        default: "smoke"
      default_check_name:
        type: string
        required: false
        default: "Miqa Kickoff"
      command_prefix:
        type: string
        required: false
        default: "/miqa"
      enable_reactions:
        type: boolean
        required: false
        default: true
      enable_help_comment:
        type: boolean
        required: false
        default: true

jobs:
  miqa:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
      contents: read

    steps:
      - name: Parse command + args
        id: args
        shell: bash
        env:
          BODY: ${{ github.event.comment.body }}
          PREFIX: ${{ inputs.command_prefix }}
          MAP: ${{ inputs.trigger_map }}
          DEFAULT_TEST: ${{ inputs.default_test }}
          DEFAULT_CHECK: ${{ inputs.default_check_name }}
          PR_NUMBER: ${{ github.event.issue.number }}
          COMMENTER: ${{ github.event.comment.user.login }}
          COMMENT_ID: ${{ github.event.comment.id }}
        run: |
          set -euo pipefail

          # Trim leading whitespace (keep original case for values)
          norm="$(echo "$BODY" | sed -e 's/^[[:space:]]*//')"

          # Lowercased copy for matching keys/prefix
          lnorm="$(echo "$norm" | tr '[:upper:]' '[:lower:]')"
          lpref="$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')"

          # Must start with prefix (wrapper already filters, but keep this safe)
          if [[ "$lnorm" != "$lpref"* ]]; then
            echo "ignore=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "ignore=false" >> "$GITHUB_OUTPUT"

          # Strip the prefix itself (use raw PREFIX length), then trim leading spaces
          rest="${norm:${#PREFIX}}"
          rest="$(echo "$rest" | sed -e 's/^[[:space:]]*//')"

          # Tokenize by whitespace (values cannot contain spaces)
          tokens=()
          while read -r tok; do
            [[ -n "$tok" ]] && tokens+=("$tok")
          done < <(printf '%s\n' $rest)

          # Defaults
          test_name=""
          trigger_id=""
          docker_uri=""
          check_name="$DEFAULT_CHECK"
          additional_pairs=()

          # If first token is "help", handle it
          if [[ "${#tokens[@]}" -ge 1 ]]; then
            t0_l="$(echo "${tokens[0]}" | tr '[:upper:]' '[:lower:]')"
            if [[ "$t0_l" == "help" ]]; then
              echo "subcmd=help" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          # Shorthand: if first token is a bare word without '=' treat as test name (e.g. "smoke")
          if [[ "${#tokens[@]}" -ge 1 && "${tokens[0]}" != *"="* ]]; then
            test_name="$(echo "${tokens[0]}" | tr '[:upper:]' '[:lower:]')"
          fi

          # Parse key=value tokens
          for tok in "${tokens[@]}"; do
            if [[ "$tok" == *"="* ]]; then
              key="${tok%%=*}"
              val="${tok#*=}"

              # strip surrounding quotes from val
              val="${val%\"}"; val="${val#\"}"
              val="${val%\'}"; val="${val#\'}"

              key_l="$(echo "$key" | tr '[:upper:]' '[:lower:]')"

              case "$key_l" in
                uri)
                  docker_uri="$val"
                  ;;
                test)
                  test_name="$(echo "$val" | tr '[:upper:]' '[:lower:]')"
                  ;;
                trigger|trigger_id)
                  trigger_id="$val"
                  ;;
                check|check_name)
                  check_name="$val"
                  ;;
                *)
                  # Unknown pairs become additional instructions
                  additional_pairs+=("$key=$val")
                  ;;
              esac
            fi
          done

          # If no explicit test_name and no trigger_id, use default
          if [[ -z "$test_name" && -z "$trigger_id" ]]; then
            test_name="$DEFAULT_TEST"
          fi

          # If trigger_id wasn't explicitly set, look up via trigger map
          if [[ -z "$trigger_id" ]]; then
            trigger_id="$(echo "$MAP" | jq -r --arg k "$test_name" '.[$k] // empty')"
            if [[ -z "$trigger_id" ]]; then
              trigger_id="__UNKNOWN__"
            fi
          fi

          # Robust URL encoding for additional instructions
          urlencode () {
            python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=''))" "$1"
          }

          add="&pr_number=$(urlencode "$PR_NUMBER")&commenter=$(urlencode "$COMMENTER")&comment_id=$(urlencode "$COMMENT_ID")"

          for pair in "${additional_pairs[@]}"; do
            k="${pair%%=*}"
            v="${pair#*=}"
            add="${add}&$(urlencode "$k")=$(urlencode "$v")"
          done

          echo "subcmd=run" >> "$GITHUB_OUTPUT"
          echo "test_name=$test_name" >> "$GITHUB_OUTPUT"
          echo "trigger_id=$trigger_id" >> "$GITHUB_OUTPUT"
          echo "docker_uri=$docker_uri" >> "$GITHUB_OUTPUT"
          echo "check_name=$check_name" >> "$GITHUB_OUTPUT"
          echo "additional_instructions=$add" >> "$GITHUB_OUTPUT"

      - name: React to comment (ack)
        if: ${{ steps.args.outputs.ignore != 'true' && inputs.enable_reactions && steps.args.outputs.subcmd != 'help' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          COMMENT_ID: ${{ github.event.comment.id }}
        run: |
          gh api -X POST "repos/${REPO}/issues/comments/${COMMENT_ID}/reactions" \
            -H "Accept: application/vnd.github+json" \
            -f content='rocket' || true

      - name: Help / unknown test message
        if: ${{ steps.args.outputs.ignore != 'true' && inputs.enable_help_comment && (steps.args.outputs.subcmd == 'help' || steps.args.outputs.trigger_id == '__UNKNOWN__') }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          MAP: ${{ inputs.trigger_map }}
          DEFAULT_TEST: ${{ inputs.default_test }}
          PREFIX: ${{ inputs.command_prefix }}
        run: |
          commands="$(echo "$MAP" | jq -r 'keys | join(", ")')"
          cat > /tmp/miqa_help.md <<EOF
          **Miqa manual trigger**

          **Usage**
          - \`$PREFIX\` (defaults to \`$DEFAULT_TEST\`)
          - \`$PREFIX smoke\`
          - \`$PREFIX test=smoke\`
          - \`$PREFIX trigger=<trigger_id>\`
          - \`$PREFIX uri=<docker_image>\`
          - Any other \`key=value\` pairs are forwarded to Miqa as additional instructions.

          **Known test names**
          $commands

          **Example**
          \`$PREFIX dockerTag=abc uri=staphb/bcftools:1.4 test=smoke random=def\`
          EOF

          gh api -X POST "repos/${REPO}/issues/${ISSUE_NUMBER}/comments" -f body=@/tmp/miqa_help.md

      - name: Stop if help/unknown/ignore
        if: ${{ steps.args.outputs.ignore == 'true' || steps.args.outputs.subcmd == 'help' || steps.args.outputs.trigger_id == '__UNKNOWN__' }}
        run: exit 0

      - name: Get PR head SHA
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.issue.number }}
        run: |
          sha=$(gh api "repos/${REPO}/pulls/${PR}" --jq .head.sha)
          echo "sha=$sha" >> "$GITHUB_OUTPUT"

      - name: Miqa Kickoff
        if: ${{ steps.args.outputs.docker_uri == '' }}
        uses: magna-labs/miqa-test-kickoff@v1.1.7
        with:
          INSTALLATION_ID: ${{ inputs.installation_id }}
          CHECK_NAME: ${{ steps.args.outputs.check_name }} (manual) PR #${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIGGER_ID: ${{ steps.args.outputs.trigger_id }}
          MIQA_ENDPOINT: ${{ inputs.miqa_endpoint }}
          MIQA_API_KEY: ${{ secrets.MIQA_API_KEY }}
          SHA: ${{ steps.pr.outputs.sha }}
          REPOSITORY: ${{ github.repository }}
          ADDITIONAL_INSTRUCTIONS: ${{ steps.args.outputs.additional_instructions }}

      - name: Miqa Kickoff (with uri)
        if: ${{ steps.args.outputs.docker_uri != '' }}
        uses: magna-labs/miqa-test-kickoff@v1.1.7
        with:
          INSTALLATION_ID: ${{ inputs.installation_id }}
          CHECK_NAME: ${{ steps.args.outputs.check_name }} (manual) PR #${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIGGER_ID: ${{ steps.args.outputs.trigger_id }}
          DOCKER_URI: ${{ steps.args.outputs.docker_uri }}
          MIQA_ENDPOINT: ${{ inputs.miqa_endpoint }}
          MIQA_API_KEY: ${{ secrets.MIQA_API_KEY }}
          SHA: ${{ steps.pr.outputs.sha }}
          REPOSITORY: ${{ github.repository }}
          ADDITIONAL_INSTRUCTIONS: ${{ steps.args.outputs.additional_instructions }}

      - name: React to comment (accepted)
        if: ${{ inputs.enable_reactions }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          COMMENT_ID: ${{ github.event.comment.id }}
        run: |
          gh api -X POST "repos/${REPO}/issues/comments/${COMMENT_ID}/reactions" \
            -H "Accept: application/vnd.github+json" \
            -f content='white_check_mark' || true
